#!/bin/bash
# ProXPN OpenVPN Bash Client
# @see: https://github.com/MattSurabian/proxpn-bash-client/
#
# If you want to use ProXPN's service but don't want to or are unable
# to install their software, this script might be what you need.
# This script relies on an OpenVPN configuration file which can be 
# extracted from ProXPNs software.
#
# Use of this script for any exit nodes other than BASIC requires a
# paid ProXPN account. The BASIC endpoint is rate limited, and a
# paid subscription is relatively cheap.
#
# Because this command runs a VPN for all your traffic you'll have to
# run it using sudo. If it is not run with sudo it will automatically use
# dry-run mode.

echo -e "\nWelcome to the ProXPN OpenVPN Bash Client!"
echo

OPENVPN=`which openvpn`
if $OPENVPN > /dev/null; then
  echo -e "\nOpenVPN not found! It must be installed before proceeding\n"
  exit 1
fi

# The recommendation is to write the ovpn file and other configuration
# information to /etc/proxpn/
CONF_BASE_PATH=/etc/proxpn/
CONF_FILE=proxpn.ovpn

# Ensure that the CONF_FILE exists
declare OPENVPN_CONF
if [ -e "$CONF_BASE_PATH$CONF_FILE" ]; then
    OPENVPN_CONF=$CONF_BASE_PATH$CONF_FILE
else
    echo "ERROR: No OpenVPN configuration file found at $CONF_BASE_PATH$CONF_FILE!"
    exit 1
fi

# By default the user will be prompted for their ProXPN username and password by
# OpenVPN. To avoid being prompted, an auth file containing two lines with the username
# on the first line and the password on the second line can be created. The
# recommendation is to call this file login.conf and store it in $CONF_BASE_PATH.
# If this file is not found, it will not be used and the user will be prompted
# for login credentials.
CREDS_FILE=login.conf

declare AUTH_CREDS
if [ -e "$CONF_BASE_PATH$CREDS_FILE" ]; then
    AUTH_CREDS=$CONF_BASE_PATH$CREDS_FILE
else
    echo "No credentials file found at $CONF_BASE_PATH$CREDS_FILE, you will be prompted by OpenVPN to login to ProXPN"
fi

# By default automatically connect to ProXPN when running this script
dryRun=false

if [ $EUID -ne 0 ]; then
   echo "This script must be run as root in order to successfully apply network route configuration."
   echo "Elevated permissions not detected, falling back to dry-run mode..."
   dryRun=true
fi

# If the user does not want to automatically connect to ProXPN they can pass -dry-run
while getopts ":dry-run" opt; do
  case $opt in
    a)
      echo -e "\n-dry-run mode active, you will not be automatically connected.\n"
      dryRun=true
      ;;
  esac
done

# Catch control-c signals to make sure we don't lose stty echo
# if we decide to prematurely quit the script.If stty echo is lost the user
# won't be able to see what they're typing into the terminal
# until reset or similar destructive command is issued. It will appear as
# if the shell is frozen or otherwise broken.
trap ctrl_c INT
function ctrl_c() {
    stty echo
    echo -e "\nProXPN OpenVPN Bash Client has been force quit. Goodbye.\n"
    exit 1
}

PORT=443

# Hosts obtained from http://proxpn.com/updater/locations-v3.xml
# and http://proxpn.com/updater/locations-v2.xml
declare -A EXIT_NODES
EXIT_NODES[Dallas]=d1.proxpn.com
EXIT_NODES[NYC]=ny1.proxpn.com
EXIT_NODES[Miami]=mfl1.proxpn.com
EXIT_NODES[Chicago]=chi1.proxpn.com
EXIT_NODES[Seattle]=se1.proxpn.com
EXIT_NODES[LA]=la1.proxpn.com
EXIT_NODES[Netherlands]=nl1.proxpn.com
EXIT_NODES[Singapore]=sg1.proxpn.com
EXIT_NODES[London]=uk1.proxpn.com
EXIT_NODES[Prague]=cz1.proxpn.com
EXIT_NODES[Stockholm]=swe1.proxpn.com
EXIT_NODES[SanJose]=openvpn-cr.proxpn.com
EXIT_NODES[Sweden]=swe1.proxpn.com

# ProXPN basic account exit nodes actually send
# users to many geo locations so there's no reason
# to include the Dallas basic exit node too.
# If however, you prefer it: bd.proxpn.com
EXIT_NODES[BASIC]=bny1.proxpn.com

declare remote

echo "Which exit node would you like to use?"

PS3="Select an exit node:"
select EXITNODE in ${!EXIT_NODES[@]};
do
    if [ ${EXIT_NODES[$EXITNODE]} ]; then
        remote=${EXIT_NODES[$EXITNODE]}
    else
        echo "ERROR: Bad selection!"
        exit 1
    fi
    break
done

# Store the command we're about to run in a variable and use the auth-nocache option
# to ensure OpenVPN doesn't attempt to cache auth information in memory
COMMAND="$OPENVPN --config $OPENVPN_CONF --remote $remote $PORT --auth-user-pass $AUTH_CREDS --auth-nocache"

# If we're in dry-run mode then print the command and exit
if [ $dryRun = true ]; then
    echo -e "\nDry run comeplete!"
    echo -e "Use following OpenVPN command to connect to ProXPN :\n$COMMAND\n"
    exit 0
fi

echo -e "Running: \n$COMMAND\n"
$COMMAND
